<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width">

        <!-- Importing Google Polymer framework -->
        <script src="dependencies/polymer/polymer.min.js"></script>
        <script src="dependencies/mobilesdk-shared/MockCordova.js"></script>
        <script src="dependencies/mobilesdk-shared/cordova.force.js"></script>
        <script src="dependencies/mobilesdk-shared/MockSmartStore.js"></script>

        <!-- Place your HTML imports here -->
        <link rel="import" href="elements/mobile-ui-elements.html">
        <link rel="import" href="dependencies/polymer-ui-elements/polymer-ui-toggle-button/polymer-ui-toggle-button.html">

        <!-- XXX following will go away once routing is moved inside force-ui-app -->
        <script src="dependencies/jquery/jquery.js"></script>
        <script src="dependencies/underscore/underscore.js"></script>
        <script src="dependencies/backbone/backbone.js"></script>
    </head>
    <body>
        <polymer-element name="account-search">
            <template>
                <header class="bar-title">
                    <h1 class="title">Accounts</h1>
                    <a class="button" href="#add">Create</a>
                </header>
                <force-ui-search id="search" sobject="Account" searchfield="Name"></force-ui-search>
                <force-selector-list id="list" sobject="Account" querytype="{{$.search.querytype}}" query="{{$.search.query}}" target="{{$.listbody}}" on-polymer-activate="{{doEdit}}">
                </force-selector-list>
                <div style="margin-top:88px /*XXX*/">
                    <ul id="listbody" class="list">
                        <template repeat="{{$.list.collection.models}}">
                            <li name="{{id}}">{{attributes.Name}}</li>
                        </template>
                    </ul>
                </div>
            </template>
            <script type="text/javascript">
            Polymer('account-search', {
                doEdit: function() {
                    app.router.navigate("#edit/accounts/" + this.$.list.selected, {trigger:true});
                },

                refresh: function() {
                    this.$.list.fetch();
                }
            });
            </script>
        </polymer-element>

        <polymer-element name="account-sync">
            <template>
                <header class="bar-title">
                    <a class="button-prev" on-click="{{goBack}}">Back</a>
                    <h1 class="title">Sync</h1>
                </header>
                <div class="bar-standard bar-header-secondary">
                    <a class="button button-block" on-click="{{doSync}}">Process {{$.list.collection.length}} records</a>
                </div>
                <div class="content">
                    <force-ui-list id="list" sobject="Account" on-polymer-activate="{{doEdit}}" querytype="cache" query="{{query}}"></force-ui-list>
                </div>
            </template>
            <script type="text/javascript">
            Polymer('account-sync', {
                query: {queryType:"exact", indexPath:"__local__", matchKey:true, order:"ascending", pageSize:25},

                doSync: function() {
                    var that = this;
                    var collection = this.$.list.collection;
                    if (collection.length == 0 || collection.at(0).get("__sync_failed__")) {
                        // we push sync failures back to the end of the list - if we encounter one, it means we are done
                        return;
                    }
                    else {
                        var record = collection.shift();

                        var options = {
                            mergeMode: Force.MERGE_MODE.MERGE_FAIL_IF_CHANGED,
                            success: function() {
                                if (collection.length == 0) {
                                    app.router.navigate("#", {trigger:true});
                                }
                                else {
                                    that.doSync();
                                }
                            },
                            error: function() {
                                record = record.set("__sync_failed__", true);
                                collection.push(record);
                                collection.doSync();
                            }
                        };

                        return record.get("__locally_deleted__") ? record.destroy(options) : record.save(null, options);
                    }
                },

                goBack: function() {
                    if (this.$.list.collection.length > 0) {
                        // We are not done - going back offline before leaving screen
                        app.onlinestatus = false;
                        // NB: This will cause us to navigate out of the sync screen
                    }
                    else {
                        app.router.navigate("#", {trigger:true});
                    }
                },

                doEdit: function() {
                    app.router.navigate("#edit/accounts/" + this.$.list.selected, {trigger:true});
                },

                refresh: function() {
                    this.$.list.fetch();
                }
            });
            </script>
        </polymer-element>

        <polymer-element name="account-detail" attributes="accountid">
            <template>
                <style>
                .right {
                    position: fixed; 
                    right: 0; 
                    margin: 20px;
                }
                </style>
                <header class="bar-title">
                    <a class="button-prev" on-click="{{goBack}}">Back</a>
                    <h1 class="title">{{action}} Account</h1>
                    <a class="button" id="toggleDeleteButton" on-click="{{doToggleDelete}}">Delete</a>
                </header>
                <div class="bar-standard bar-header-secondary">
                  <a class="button" id="saveButton" on-click="{{doSave}}">Save</a>
                  <a class="button" id="mergeButton" on-click="{{doMerge}}">Merge</a>
                  <a class="button" id="overwriteButton" on-click="{{doOverwrite}}">Overwrite</a>
                  <span class="count-main right" id="localChangeSpan"></span>
              </div>
                <div class="content">
                    <force-ui-detail flex id="detail" sobject="Account" recordid="{{accountid}}" foredit="true"></force-ui-detail>
                </div>
            </template>
            <script type="text/javascript">
            Polymer('account-detail', {
                observe: {
                    "accountid": "reset"
                },

                get force_sobject() {
                    return this.$.detail.$.force_sobject;
                },

                reset: function() {
                    var model = this.$.detail.model;
                    $(this.$.mergeButton).hide();
                    $(this.$.overwriteButton).hide();
                    this.backAction = app.router.getPreviousPage();

                    if (model.get("__local__")) {
                        $(this.$.localChangeSpan).html("Locally " 
                                + (model.get("__locally_created__") ? "created " : "") 
                                + (model.get("__locally_updated__") ? "updated " : "") 
                                + (model.get("__locally_deleted__") ? "deleted" : ""))
                        $(this.$.localChangeSpan).show();
                    }
                    else {
                        $(this.$.localChangeSpan).hide();
                    }

                    if (this.accountid == null) {
                        this.action = "Add";
                        // model.set({__local__: false, Name:"", Industry:"", Phone:"", LastModifiedDate:"", attributes : { type: "Account"}});   
                        $(this.$.toggleDelete).hide();
                    }
                    else {
                        this.action = "Edit";
                        $(this.$.toggleDeleteButton).html(model.get("__locally_deleted__") ? "Undelete" : "Delete");
                        $(this.$.toggleDelete).show();
                    }
                },

                goBack: function() {
                    app.router.navigate("#", {trigger:true});
                },

                getSaveOptions: function(mergeMode, cacheMode) {
                    var that = this;

                    return {
                        cacheMode: cacheMode,
                        mergeMode: mergeMode,
                        success: function() { app.router.navigate(that.backAction, {trigger:true}); },
                        error: function(data, err, options) { that.handleError(new Force.Error(err)); },
                        // fieldlist: ["Id", "Name", "Industry", "Phone"]
                        fieldlist: _.keys(this.$.detail.model.changed) // XXX shouldn't have to do that
                    };
                },

                handleError: function(error) {
                    // var that = this;
                    // if (error.type === "RestError") {
                    //     _.each(error.details, function(detail) {
                    //         if (detail.fields == null || detail.fields.length == 0) { alert(detail.message); }
                    //         else {_.each(detail.fields, function(field) {that.showFieldError(field, detail.message);});}
                    //     });
                    // }
                    // else if (error.type == "ConflictError") {
                    //     _.each(error.remoteChanges, function(field) {
                    //         var conflict = error.conflictingChanges.indexOf(field) >=0;
                    //         that.showFieldError(field, "Server: " +  error.theirs[field], conflict);
                    //     });
                    //     $(".merge", this.el).show();
                    //     $(".overwrite", this.el).show();
                    // }
                    if (error.type == "ConflictError") {
                        $(this.$.mergeButton).show();
                        $(this.$.overwriteButton).show();
                    }
                },


                doSave: function() {
                    this.force_sobject.save(this.getSaveOptions(Force.MERGE_MODE.MERGE_FAIL_IF_CHANGED));
                },

                doSaveMerge: function() {
                    this.force_sobject.save(this.getSaveOptions(Force.MERGE_MODE.MERGE_ACCEPT_YOURS));
                },

                doSaveOverwrite: function() {
                    this.force_sobject.save(this.getSaveOptions(Force.MERGE_MODE.OVERWRITE));
                },

                doToggleDelete: function() {
                    var model = this.$.detail.model;
                    if (model.get("__locally_deleted__")) {
                        model.set("__locally_deleted__", false);
                        this.force_sobject.save(this.getSaveOptions(null, Force.CACHE_MODE.CACHE_ONLY));
                    }
                    else {
                        this.force_sobject.delete({
                            success: function(data) {
                                app.router.navigate("#", {trigger:true});
                            },
                            error: function(data, err, options) {
                                var error = new Force.Error(err);
                                alert("Failed to delete account: " + (error.type === "RestError" ? error.details[0].message : "Remote change detected - delete aborted"));
                            }
                        });
                    }
                }
            })
            </script>
        </polymer-element>

        <polymer-element name="mobile-app">
            <template>
                <force-ui-app id="force_ui_app" multipage="true" accesstoken="{{accesstoken}}" instanceurl="{{instanceurl}}" hideheader="true">
                    <account-search id="account_search" class="page absolute"></account-search>
                    <account-detail id="account_detail" class="page absolute"></account-detail>
                    <account-sync id="account_sync" class="page absolute"></account-sync>
                </force-ui-app>
                <polymer-ui-toggle-button value="{{onlinestatus}}" onCaption="Online" offCaption="Offline" style="position: fixed; bottom: 0; right: 0; margin: 20px;"></polymer-ui-toggle-button>
            </template>
            <script type="text/javascript">
            Polymer('mobile-app', {
                accesstoken: '00Di0000000gWVG!ARcAQARIGWPjWqSVsJg0OP.stxh5m8zrPB6IWSOCsJWWgznAzQIWPssPv3yuadxQI3.dZ.3YDGy4mV33bZ_dGj1nD1Xg68tW',
                instanceurl: 'https://na15.salesforce.com',

                _onlineStatus: true,

                get onlinestatus() {
                    return this._onlineStatus;
                },

                set onlinestatus(newStatus) {
                    if (newStatus && !this._onlineStatus) {
                        app.router.navigate("#sync", {trigger:true})
                    }
                    else if (!newStatus && document.location.hash == "#sync") {
                        app.router.navigate("#", {trigger:true});
                    }

                    SFDC.isOnline = function() { return newStatus }; // XXX
                    this._onlineStatus = newStatus;
                },

                ready: function() {
                    var app = this;
                    var Router = Backbone.Router.extend({
                        currentPageId: null,
                        hashHistory: [],

                        routes: {
                            "": "list",
                            "list": "list",
                            "add": "addAccount",
                            "edit/accounts/:id": "editAccount",
                            "sync":"sync"
                        },

                        gotoPage: function(targetId) {
                            console.log("+ Navigating to [" + window.location.hash + "]");

                            // First page loaded
                            if (!this.currentPageId) {
                                this.hashHistory = [window.location.hash];
                                this.currentPageId = targetId;
                                // first page is automatically loaded, we don't need to "navigate" to it
                            }
                            // New page is the same as the previous page -> back transition
                            else if (this.hashHistory.length > 1 && window.location.hash === this.hashHistory[this.hashHistory.length - 2]) {
                                this.hashHistory.pop();
                                app.$.force_ui_app.navigateBack();
                            } 
                            // Otherwise forward transition
                            else {
                                this.hashHistory.push(window.location.hash);
                                app.$.force_ui_app.navigateTo(targetId);
                            }
                        },

                        getPreviousPage: function() {
                            return (this.hashHistory != null && this.hashHistory.length > 1 ? this.hashHistory[this.hashHistory.length - 2] : "#");
                        },

                        list: function() {
                            app.$.account_search.refresh();
                            this.gotoPage('#account_search');
                        },

                        addAccount: function() {
                            app.$.account_detail.accountid = "";
                            this.gotoPage('#account_detail');
                        },

                        editAccount: function(accountid) {
                            app.$.account_detail.accountid = accountid;
                            this.gotoPage('#account_detail');
                        },

                        sync: function() {
                            app.$.account_sync.refresh();
                            this.gotoPage('#account_sync');
                        }

                    });
                    this.router = new Router();
                    Backbone.history.start();
                }
            });
            </script>
        </polymer-element>

        <mobile-app></mobile-app>
        
        <script type="text/javascript">
        var app = $("mobile-app")[0];
        </script>
    </body>
</html>
